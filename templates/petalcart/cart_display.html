{% extends 'main.html' %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/cart.css' %}">

<div class="cart-container">

  <!-- Left Column: Product List -->
  <div class="cart-card">
    <h3>Your Shopping Cart</h3>

    {% if items %}
      {% for item in items %}
      <div class="cart-item">

        <!-- Product Image -->
        <div class="item-image">
          <img src="{{ item.flower.img.url }}" alt="{{ item.flower.flowername }}">
        </div>

        <!-- Product Details -->
        <div class="item-details">
          <h4>{{ item.flower.flowername }}</h4>
          <p>Unit Price: â‚¹{{ item.flower.price }}</p>

          <!-- Quantity Update Form -->
          <form id="cart-form-{{ item.id }}" method="post" action="{% url 'update_cart' item.id %}">
            {% csrf_token %}
            <div class="quantity-controls">
              <button type="button" onclick="changeQuantity(-1, {{ item.id }})">-</button>

              <input type="number" 
                     id="qty-{{ item.id }}"
                     name="quantity" 
                     value="{{ item.quantity }}" 
                     min="1" 
                     max="{{ item.flower.stock.quantity }}"
                     onchange="updateQuantity({{ item.id }}, this.value)">
              
              <button type="button" onclick="changeQuantity(1, {{ item.id }})">+</button>
            </div>

            <a href="{% url 'delete_cart' item.id %}" 
               style="color:#dc3545; text-decoration:none; margin-left:10px;">
               Remove
            </a>
          </form>
        </div>

        <!-- Item Total -->
        <div class="item-total">
          â‚¹{{ item.subtotal }}
        </div>

      </div>
      {% endfor %}

    {% else %}
      <div style="padding: 40px; text-align: center;">
        <h3>Your cart is empty ðŸŒ¸</h3>
        <a href="{% url 'home' %}" style="color: #007bff;">Continue Shopping</a>
      </div>
    {% endif %}
  </div>

  <!-- Right Column: Checkout Summary -->
  {% if items %}
  <div class="cart-card">
    <h3>Summary</h3>

    <div class="summary-row">
      <span>Subtotal</span>
      <span>â‚¹{{ total_price }}</span>
    </div>

    <div class="summary-row">
      <span>Shipping</span>
      <span style="color: #28a745;">FREE</span>
    </div>

    <div class="total-row">
      <span>Total</span>
      <span>â‚¹{{ total_price }}</span>
    </div>

    <form method="POST" action="{% url 'checkout_cart' %}">
        {% csrf_token %}
        
        <!-- Support Discount Option -->
        <div style="background-color: #f0f8ff; border: 1px solid #b0e0e6; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
              <input 
                  type="checkbox" 
                  id="use_dev_pricing" 
                  name="use_dev_pricing" 
                  value="yes"
                  checked
                  style="width: 18px; height: 18px; cursor: pointer;"
              >
              <span style="color: #0066cc; font-weight: 500; margin: 0;">
                  ðŸš€ Early Supporter - Pay Only <strong>10%</strong> (Still in Development)
              </span>
          </label>
          <p style="color: #0066cc; font-size: 0.85rem; margin: 6px 0 0 28px;">
              Help us develop this product - Pay just 10% now! Regular price applies after launch.
          </p>
        </div>

        <button type="submit" class="btn">Proceed to Checkout</button>
    </form>
  </div>
  {% endif %}

</div>

<!-- JS (Optional) -->
<script>
function getCartQuantityInput(id) {
  return document.getElementById(`qty-${id}`);
}

function getCartForm(id) {
  return document.getElementById(`cart-form-${id}`);
}

function changeQuantity(amount, id) {
  const input = getCartQuantityInput(id);
  const form = getCartForm(id);
  if (!input || !form) return;

  const currentVal = parseInt(input.value || '1', 10);
  const newVal = currentVal + amount;
  if (newVal >= 1) {
    input.value = newVal;
    form.submit();
  }
}

function updateQuantity(id, val) {
  const form = getCartForm(id);
  if (!form) return;
  form.submit();
}
</script>

{% endblock %}
