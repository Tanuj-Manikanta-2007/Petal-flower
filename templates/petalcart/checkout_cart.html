def checkout_cart(request):
    if request.method != 'POST':
        return redirect('cart_view')

    cart = get_object_or_404(Cart, user=request.user)
    cart_items = cart.items.all()

    if not cart_items:
        messages.error(request, "Your cart is empty.")
        return redirect('cart_view')

    with transaction.atomic():
        total = sum(item.flower.price * item.quantity for item in cart_items)

        order = Order.objects.create(
            user=request.user,
            total=total,
            status="Pending"
        )

        for item in cart_items:
            OrderItem.objects.create(
                order=order,
                flower=item.flower,
                quantity=item.quantity,
                price=item.flower.price
            )

            item.flower.stock.quantity -= item.quantity
            item.flower.stock.save()

        cart_items.delete()

    return redirect('order_history')
